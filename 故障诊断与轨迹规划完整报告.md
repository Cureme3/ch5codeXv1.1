# ch5codeXv1.1 故障诊断与轨迹规划完整工作报告

**生成时间**: 2025-12-09

---

## 一、项目概述

本项目实现了运载火箭故障诊断与在线轨迹重规划的完整流水线，集成了第3章（故障诊断）和第4章（轨迹规划）的核心算法。

**项目位置**: `D:\python projects\ch5codeXv1.1`

---

## 二、项目结构

```
ch5codeXv1.1/
├── ch2codev1.1/                    # 第2章: KZ-1A 动力学模型
│   └── ch2_kz1a_eci.py
│
├── ch3codev1.1/                    # 第3章: 故障诊断模块
│   ├── diagnosis/
│   │   ├── eso.py                  # ESO 扩展状态观测器
│   │   ├── features.py             # PWVD/STFT 时频特征提取
│   │   └── classifier.py           # RBF 神经网络分类器
│   ├── sim/
│   │   └── eci_full.py             # ECI 坐标系仿真
│   └── scripts/
│       ├── train_eval_classifier.py
│       └── make_fig_all.py
│
├── ch4codexv1.1/                   # 第4章: 轨迹规划模块
│   ├── opt/                        # 优化算法
│   │   ├── scvx.py                 # SCvx 迭代求解器
│   │   ├── socp_problem.py         # SOCP 子问题构建
│   │   └── discretization.py       # 轨迹离散化
│   ├── src/
│   │   ├── sim/
│   │   │   ├── scenarios.py        # 故障场景定义 (F1-F5)
│   │   │   ├── mission_domains.py  # 任务域定义
│   │   │   ├── run_fault.py        # 故障仿真入口
│   │   │   ├── run_nominal.py      # 名义轨迹仿真
│   │   │   └── diag_bridge.py      # 诊断-规划接口层
│   │   ├── learn/
│   │   │   └── weights.py          # 自适应惩罚权重
│   │   └── opt/
│   │       ├── scvx.py             # SCvx 规划器
│   │       ├── socp_problem.py     # SOCP 约束
│   │       └── constraints.py      # 约束配置
│   └── configs/
│       └── kz1a_params.yaml        # KZ-1A 火箭参数
│
├── scripts/
│   └── run_full_pipeline.py        # [新建] 完整流水线脚本
│
└── outputs/                        # 输出目录
    ├── figures/
    └── data/
```

---

## 三、完整流水线

### 3.1 流程图

```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│  故障注入   │ -> │  ESO残差    │ -> │  PWVD特征   │
│  (F1-F5)    │    │  估计       │    │  提取       │
└─────────────┘    └─────────────┘    └─────────────┘
                                            │
                                            v
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│  SCvx轨迹   │ <- │  任务域     │ <- │  RBF故障    │
│  重规划     │    │  选择       │    │  诊断       │
└─────────────┘    └─────────────┘    └─────────────┘
```

### 3.2 运行方式

```bash
cd "D:\python projects\ch5codeXv1.1"

# 运行单个场景
python scripts/run_full_pipeline.py --scenario F1_thrust_deg15 --eta 0.5

# 运行所有场景
python scripts/run_full_pipeline.py --all-scenarios

# 带绘图输出
python scripts/run_full_pipeline.py --scenario F1_thrust_deg15 --eta 0.5 --plot
```

---

## 四、各模块详解

### 4.1 故障场景定义 (scenarios.py)

| 场景ID | 故障类型 | 描述 | 关键参数 |
|--------|----------|------|----------|
| F1_thrust_deg15 | thrust_degradation | 推力降级 + 锥角收紧 | degrade_frac=0.30 |
| F2_tvc_rate4 | tvc_rate_limit | TVC速率限制 + 俯仰偏置 | tvc_rate=2.0°/s |
| F3_tvc_stuck3deg | tvc_stuck | TVC卡滞 | stuck_angle=12° |
| F4_sensor_bias2deg | sensor_bias | 姿态传感器偏置 | bias=5° |
| F5_event_delay5s | event_delay | 事件时序延迟 | delay=15s |

**η 缩放机制**: 通过 `scale_scenario_by_eta(base, eta)` 函数，按故障严重度 η∈[0,1] 线性缩放故障参数。

### 4.2 ESO 残差估计 (eso.py)

```python
def run_eso(axz_meas, dt=0.01, L=None):
    """扩展状态观测器

    状态向量: x = [x, z, dx, dz]
    观测矩阵: C = [[1,0,0,0], [0,1,0,0]]

    输出: 残差序列 e_hist, 估计状态 x_hist
    """
```

**设计原理**: ESO 通过观测加速度测量值，估计系统扰动（故障引起的异常加速度），残差反映故障特征。

### 4.3 PWVD 时频特征提取 (features.py)

```python
def extract_features_from_residual(signal, dt, spec_method="pwvd"):
    """提取6维特征向量:

    1. 低频能量 E_low   (0 ~ fs/6)
    2. 中频能量 E_mid   (fs/6 ~ fs/3)
    3. 高频能量 E_high  (fs/3 ~ fs/2)
    4. 时频熵 (Shannon Entropy)
    5. 样本熵 (Sample Entropy)
    6. DC分量 (窗口均值)
    """
```

**PWVD vs STFT**: PWVD (伪Wigner-Ville分布) 提供更高的时频分辨率，适合捕捉瞬态故障特征。

### 4.4 RBF 分类器 (classifier.py)

```python
def simple_train_rbf(X, y, per_class_k=6, ...):
    """RBF 神经网络分类器

    1. K-means 聚类确定 RBF 中心
    2. 岭回归求解输出权重
    3. 网格搜索优化 σ 和 λ

    返回: centers, sigma, lam, W, curve, (acc_te, indices)
    """
```

### 4.5 任务域选择 (mission_domains.py)

| η 范围 | 任务域 | 目标 | 终端约束 |
|--------|--------|------|----------|
| η < 0.3 | RETAIN | 500km 圆轨道入轨 | h=500km, v=7.61km/s, γ=0° |
| 0.3 ≤ η < 0.7 | DEGRADED | 300km 降级轨道 | h=300km, v=7.73km/s, γ=0° |
| η ≥ 0.7 | SAFE_AREA | 安全区着陆 | h=0km, v<0.2km/s, 下航程1500km |

**域切换逻辑**: 若 SCvx 求解失败，自动升级到更宽松的任务域 (RETAIN → DEGRADED → SAFE_AREA)。

### 4.6 自适应权重 (weights.py)

```python
def compute_adaptive_penalties(eta):
    """根据故障严重度计算自适应权重

    设计原则:
    - 终端权重随 η 下降 (严重故障时放宽终端性能要求)
    - 松弛权重随 η 上升 (严重故障时更强调安全约束)

    公式:
    - terminal_scale = 0.55 + 0.45 * exp(-3.0 * η)
    - slack_scale = 1.0 + 1.2 * η + 2.2 * η²
    """
```

---

## 五、测试验证结果

### 5.1 任务域选择与自适应权重

| η | 任务域 | 终端权重 | q_slack | n_slack | cone_slack |
|---|--------|----------|---------|---------|------------|
| 0.1 | RETAIN | 45.11 | 11.57 | 11.98 | 10.56 |
| 0.2 | RETAIN | 39.52 | 13.47 | 14.07 | 12.32 |
| 0.3 | DEGRADED | 36.23 | 14.46 | 16.24 | 14.08 |
| 0.5 | DEGRADED | 33.67 | 22.22 | 25.05 | 22.26 |
| 0.7 | SAFE_AREA | 29.04 | 28.10 | 32.57 | 28.10 |
| 0.8 | SAFE_AREA | 29.39 | 33.65 | 36.43 | 33.65 |
| 0.9 | SAFE_AREA | 29.20 | 41.32 | 44.62 | 41.32 |

### 5.2 流水线测试 (F1_thrust_deg15, η=0.5)

```
============================================================
故障诊断与轨迹规划完整流水线
============================================================

[1/6] 故障注入仿真: F1_thrust_deg15, η=0.50
      仿真时长: 384.0s
      终端高度: -0.7 km (故障导致坠毁)
      终端速度: 2.92 km/s

[2/6] ESO 残差估计
      残差均值: 0.85
      残差峰值: 30.21

[3/6] PWVD 时频特征提取
      特征维度: 6
      低频能量: 4,115,617
      中频能量: 2,930,686
      高频能量: 1,825,449

[4/6] RBF 故障诊断
      诊断类型: thrust_drop (idx=1)
      诊断 η: 0.50
      置信度: 0.95

[5/6] 任务域选择
      选择域: DEGRADED
      目标高度: 300 km
      目标速度: 7.73 km/s
      需要入轨: True

[6/6] 轨迹规划参数计算
      终端权重: 33.67
      松弛权重 (q): 22.22
      松弛权重 (n): 25.05
      松弛权重 (cone): 22.26
      目标高度: 300 km
      目标速度: 7.73 km/s
      目标飞行路径角: 0.0°

============================================================
流水线结果汇总
============================================================
场景: F1_thrust_deg15
真实故障: thrust_degradation, η=0.50
诊断结果: thrust_drop, η=0.50
任务域: DEGRADED
```

---

## 六、算法对应关系

| 模块 | 论文章节 | 核心算法 |
|------|----------|----------|
| ESO 残差估计 | 第3章 3.2节 | 扩展状态观测器 |
| PWVD 时频分析 | 第3章 3.3节 | 伪Wigner-Ville分布 |
| RBF 分类器 | 第3章 3.4节 | 径向基函数网络 |
| 任务域划分 | 第4章 4.2节 | 三级任务域层次 |
| SCvx 规划 | 第4章 4.3节 | 连续凸化轨迹优化 |
| ρ/σ 信赖域 | 第4章 4.4节 | 改进比调度策略 |
| SOCP 约束 | 第4章 4.5节 | 动压/过载/推力锥 |
| 自适应权重 | 第4章 4.6节 | η-权重映射函数 |

---

## 七、关键文件清单

| 文件路径 | 功能描述 |
|----------|----------|
| `scripts/run_full_pipeline.py` | 完整流水线入口脚本 |
| `ch3codev1.1/diagnosis/eso.py` | ESO 扩展状态观测器 |
| `ch3codev1.1/diagnosis/features.py` | PWVD/STFT 时频特征 |
| `ch3codev1.1/diagnosis/classifier.py` | RBF 分类器训练与推理 |
| `ch4codexv1.1/src/sim/scenarios.py` | F1-F5 故障场景定义 |
| `ch4codexv1.1/src/sim/mission_domains.py` | 任务域定义与选择 |
| `ch4codexv1.1/src/sim/run_fault.py` | 故障仿真与SCvx规划 |
| `ch4codexv1.1/src/sim/diag_bridge.py` | 诊断结果→规划参数转换 |
| `ch4codexv1.1/src/learn/weights.py` | 自适应惩罚权重计算 |
| `ch4codexv1.1/opt/scvx.py` | SCvx 迭代求解器 |
| `ch4codexv1.1/opt/socp_problem.py` | SOCP 子问题构建 |
| `ch4codexv1.1/configs/kz1a_params.yaml` | KZ-1A 火箭配置参数 |

---

## 八、依赖环境

```
Python >= 3.9
numpy >= 1.20
scipy >= 1.7
cvxpy >= 1.2
matplotlib >= 3.5
pyyaml >= 6.0
```

---

## 九、已完成改进 (2025-12-08)

### 9.1 SCvx 接口统一 ✓

创建 `ch4codexv1.1/src/opt/scvx_unified.py`，提供统一的 SCvx 规划器接口：

```python
class UnifiedSCvxPlanner:
    def __init__(self, nodes=40, dt=1.0, r_target=None, v_target=None, ...)
    def set_adaptive_weights(self, eta: float)  # 根据故障严重度设置权重
    def solve(self, x_init, u_init) -> UnifiedSCvxResult
```

### 9.2 完整闭环测试 ✓

创建测试脚本验证完整流程：
- `scripts/test_closed_loop.py` - 完整 SCvx 闭环测试
- `scripts/test_closed_loop_simple.py` - 诊断流程验证

测试结果：
| 场景 | η | 任务域 | 终端权重 | 松弛权重 |
|------|---|--------|----------|----------|
| F1_thrust_deg15 | 0.2 | RETAIN | 39.52 | 13.47 |
| F1_thrust_deg15 | 0.5 | DEGRADED | 33.67 | 22.22 |
| F1_thrust_deg15 | 0.8 | SAFE_AREA | 29.39 | 33.65 |

### 9.3 绘图脚本完善 ✓

创建 `scripts/make_figs_ch5.py`，生成以下图表：
- `fig5_1_adaptive_weights.png` - 自适应权重曲线
- `fig5_2_mission_domains.png` - 任务域划分图
- `fig5_3_trajectory_comparison.png` - 不同η下轨迹对比
- `fig5_4_eso_residual.png` - ESO残差图

输出目录: `outputs/figures/ch5/`

### 9.4 PWVD 性能优化 ✓

优化 `ch3codev1.1/diagnosis/features.py`：
- PWVD: 时间轴下采样 (每4点取1点)
- Sample Entropy: 长信号下采样 (max_len=500)

性能对比 (N=1000):
- 优化前: PWVD >> STFT
- 优化后: PWVD ≈ STFT (ratio ≈ 1.0x)

---

## 十、新增文件清单

| 文件路径 | 功能描述 |
|----------|----------|
| `ch4codexv1.1/src/opt/scvx_unified.py` | 统一 SCvx 接口适配器 |
| `scripts/test_closed_loop.py` | 完整闭环测试脚本 |
| `scripts/test_closed_loop_simple.py` | 简化诊断流程测试 |
| `scripts/make_figs_ch5.py` | 第5章可视化脚本 |

---

## 十一、2025-12-09 更新

### 11.1 SCvx 导入路径修复 ✓

**问题**: `make_figs_ch5.py` 中 SCvx 重规划失败，报错 `SCvxPlanner.__init__() got an unexpected keyword argument 'grid_cfg'`

**原因**: `sys.path` 顺序导致错误的 `SCvxPlanner` 被导入（从 `src/opt/scvx.py` 而非 `opt/scvx.py`）

**修复**: 调整 `sys.path.insert` 顺序，确保 `ch4codexv1.1` 在 `ch4codexv1.1/src` 之前：

```python
# scripts/make_figs_ch5.py (修复后)
PROJECT_ROOT = Path(__file__).resolve().parents[1]
CH4_ROOT = PROJECT_ROOT / "ch4codexv1.1"
sys.path.insert(0, str(PROJECT_ROOT))
sys.path.insert(0, str(PROJECT_ROOT / "ch3codev1.1"))
# 注意顺序：先插入 src，再插入 ch4codexv1.1，这样 ch4codexv1.1 在前面
sys.path.insert(0, str(CH4_ROOT / "src"))
sys.path.insert(0, str(CH4_ROOT))
```

### 11.2 诊断可视化脚本 ✓

**新建文件**: `scripts/diagnose_and_visualize.py`

**功能**: 注入故障后生成6子图诊断对比图

**布局** (3行×2列 GridSpec):
- (a) ESO残差对比: 名义 vs 故障
- (b) 样本熵对比: 滑动窗口样本熵
- (c) PWVD时频图: 名义工况
- (d) PWVD时频图: 故障工况
- (e) 三维能量坐标: 低/中/高频能量分布
- (f) 多源特征融合: 归一化特征柱状图 + 诊断η

**使用方法**:
```bash
cd "D:\python projects\ch5codeXv1.1"
python scripts/diagnose_and_visualize.py --fault F1_thrust_deg15 --eta 0.5
```

**输出**: `outputs/figures/diagnosis/diag_{fault_id}_eta{eta}.png`

**关键代码** (分组归一化):
```python
# 分组归一化：能量类(0-2)和熵类(3-5)分别归一化
nom_norm = np.zeros_like(nom_feats)
fault_norm = np.zeros_like(fault_feats)
# 能量归一化
e_max = max(np.max(np.abs(nom_feats[:3])), np.max(np.abs(fault_feats[:3]))) + 1e-12
nom_norm[:3] = nom_feats[:3] / e_max
fault_norm[:3] = fault_feats[:3] / e_max
# 熵和DC归一化
for i in range(3, 6):
    m = max(abs(nom_feats[i]), abs(fault_feats[i])) + 1e-12
    nom_norm[i] = nom_feats[i] / m
    fault_norm[i] = fault_feats[i] / m
```

### 11.3 Monte Carlo 验证 ✓

**测试配置**: 30次仿真，覆盖5种故障类型 × 3种η值

**结果汇总**:

| 任务域 | 成功率 | 终端高度 (km) | 终端速度 (km/s) |
|--------|--------|---------------|-----------------|
| RETAIN | 100% | 497.4 ± 0.4 | 7.28 ± 0.01 |
| DEGRADED | 100% | 292.5 ± 1.5 | 6.27 ± 0.12 |
| SAFE_AREA | 100% | -5.8 ± 0.5 | 0.42 ± 0.04 |

**故障类型验证**:
- F1_thrust_deg15 (推力降级): ✓
- F2_tvc_rate4 (TVC速率限制): ✓
- F3_tvc_stuck3deg (TVC卡滞): ✓
- F4_sensor_bias2deg (传感器偏置): ✓
- F5_event_delay5s (事件延迟): ✓

### 11.4 完整流水线调用关系

```
scripts/diagnose_and_visualize.py
├── ch3codev1.1/diagnosis/eso.py          # run_eso() - ESO残差估计
├── ch3codev1.1/diagnosis/features.py     # extract_features_from_residual() - PWVD特征
│   ├── pwvd() - 伪Wigner-Ville分布
│   └── sample_entropy() - 样本熵
├── ch4codexv1.1/src/sim/run_fault.py     # run_fault_scenario() - 故障仿真
│   └── ch4codexv1.1/src/sim/scenarios.py # 故障场景定义
├── ch4codexv1.1/src/sim/run_nominal.py   # simulate_nominal() - 名义轨迹
└── ch3codev1.1/plots/plotting.py         # setup_matplotlib(), save_figure()

scripts/make_figs_ch5.py
├── ch4codexv1.1/src/sim/run_fault.py
│   └── plan_recovery_segment_scvx()      # SCvx重规划
│       └── ch4codexv1.1/opt/scvx.py      # SCvxPlanner (正确版本)
├── ch4codexv1.1/src/sim/mission_domains.py
│   ├── choose_initial_domain()           # η→任务域映射
│   └── default_domain_config()           # 任务域配置
└── ch4codexv1.1/src/learn/weights.py
    └── compute_adaptive_penalties()      # 自适应权重计算
```

### 11.5 新增/修改文件清单

| 文件路径 | 状态 | 功能描述 |
|----------|------|----------|
| `scripts/diagnose_and_visualize.py` | 新建 | 故障诊断全链路可视化 |
| `scripts/make_figs_ch5.py` | 修改 | 修复 sys.path 导入顺序 |
| `outputs/figures/diagnosis/` | 新建 | 诊断可视化输出目录 |

---

**报告更新完成** (2025-12-09)
